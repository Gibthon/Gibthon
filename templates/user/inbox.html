{% extends "base.html" %}

{% block css-include %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}/css/datatable.css" />
<style type="text/css">
td.centre {
	text-align:center;
}
span.origin_icon {
	float:right;
	margin:5px;
}
span.type_icon {
	float:right;
	margin:5px;
}
td {
	padding-left:5px;
}
</style>
{% endblock %}


{% block js-include %}
<script src="{{ STATIC_URL }}/js/jquery.dataTables.min.js" type="text/javascript"></script>
{% endblock %}

{% block menu %}
|
<a href="add">Add Selected</a>
{% endblock %}

{% block content %}
<div class="ui-widget-content ui-corner-all content">
<h2>Inbox</h2>
<h4>{{ user.channel }}</h4>
<p>You have {{ user.inbox.unread.count }} unread message{{ user.inbox.unread.count|pluralize }} and {{ user.inbox.not_added.count }} not yet added.</p>
<div style="padding:10px;">
	<table class="inbox_table">
		<thead>
			<tr><th></th><th>Received</th><th>From</th><th>Description</th><th>Add</th><th></th><th></th><th>Del</th></tr>
		</thead>
		<tbody>
			 {% for message in user.inbox.message.all %}
				<tr>
					<td>
						<span class="ui-icon ui-icon-circle-plus" style="margin:6px 6px 6px 2px;"></span>
					</td><td>
						{{ message.received|date:"j/n/y G:i" }}
						{% if message.read %}
						{% else %}
							<span style="color:red; font-weight:bold; font-size:0.6em; padding-left:5px;">New</span>
						{% endif %}
					</td><td>
						{{ message.sender }}
					</td><td>
						{{ message.description }}
					</td><td>
						<input class="add_message" type="checkbox"{% if message.added %} checked="true" disabled="true"{% endif %} />
					</td><td>
						{{ message.id }}
					</td><td>
						{{ message.received|date:"U" }}
					</td><td>
						<input class="del_message" type="checkbox" />
					</td>
				</tr>
			{% endfor %}
		</tbody>
		<tfoot>
			<tr> <td></td> <td></td> <td></td> <th>
				Type <select>
					<option value="">---------</option>
					<option>Construct</option>
					<option>Fragment</option>
				</select>
				Origin <select>
					<option value="">------------------------</option>
					<option>Gibthon Construct Designer</option>
					<option>Genetic Engineering of Cells</option>
					<option>Parts Registry</option>
					<option>Unknown</option>
				</select>
				</th> <th style="text-align:center; padding-left:5px;">
					<input type="checkbox" id="add_all" />
				</th> <th></th> <th></th>
				<th style="text-align:center; padding-left:5px;">
					<input type="checkbox" id="del_all" />
				</th> </tr>
		</tfoot>
	</table>
</div>

</div>
{% endblock %}

{% block dialog %}
{% endblock %}


{% block js %}
<script type="text/javascript">

var messageDetail = function ( nTr ) {
	sOut = '<p>Message content</p><textarea cols="104" rows="10" readonly="true" style="font-family:monospace;" id="message_detail"></textarea>';
	return sOut;
}
var openRow = '';

$(document).ready(function() {
	$('.inbox_table').dataTable({
		bAutoWidth: false,
		bJQueryUI: true,
		aaSorting: [[1,'desc']],
		aoColumns: [
			{
				sWidth:"10px",
				bSortable:false
			},
			{
				sWidth:"200px",
				iDataSort:6
			},
			{
				sWidth:"150px"
			},
			{
				sWidth:"504px",
				bSortable:false,
				bSearchable:false
			},
			{
				sClass:"centre",
				bSortable:false,
				bSearchable:false
			},
			{
				bVisible:false,
				bSortable:false
			},
			{
				bVisible:false,
				bSearchable:false
			},
			{
				sClass:"centre",
				bSearchable:false,
				bSortable:false,
			}
		]
	});
	$('.inbox_table tr td:first-child span').live('click', function () {
		var nTr = this.parentNode.parentNode;
		if (openRow != '' && openRow != nTr) {
			$('.inbox_table').dataTable().fnClose(openRow);
			var icon = $('td:first-child span', openRow);
			icon.removeClass('ui-icon-circle-minus');
			icon.addClass('ui-icon-circle-plus');
		}
		if ($(this).hasClass('ui-icon-circle-minus')) {
			$('.inbox_table').dataTable().fnClose(nTr);
			$(this).removeClass('ui-icon-circle-minus');
			$(this).addClass('ui-icon-circle-plus');
			openRow = ''
		} else {
			$('.inbox_table').dataTable().fnOpen(nTr, messageDetail(nTr), 'details');
			var message_id = $('.inbox_table').dataTable().fnGetData(nTr)[5];
			$('textarea#message_detail').load(message_id+'/detail');
			$(this).removeClass('ui-icon-circle-plus');
			$(this).addClass('ui-icon-circle-minus');
			$('+ td span', this.parentNode).remove();
			openRow = nTr;
		}
	});
	$('.inbox_table select').change(function () {
		$('.inbox_table').dataTable().fnFilter( $(this).val(), 3);
	});
	$('input#add_all').change(function () {
		$('input.add_message:enabled').attr('checked', $(this).is(':checked'));	
	});
	$('input#del_all').change(function () {
		$('input.del_message').attr('checked', $(this).is(':checked'));
	});
	$('a[href="add"]').button({
		icons:{primary:'ui-icon-plusthick'}
	}).click(function(event) {
		event.preventDefault();
		var table = $('.inbox_table').dataTable();
		var toAdd = [];
		$('input:checkbox:enabled:checked').each(function () {
			var nTr = this.parentNode.parentNode;
			toAdd.push(parseInt(table.fnGetData(nTr)[5]));
		});
		$.post('add', {'mids':toAdd}, function(data) {
			console.log(data);
		});
	});
});
</script>
{% endblock %}
